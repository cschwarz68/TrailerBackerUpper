<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>gamepad_py.html</title>
        <style type="text/css">
          .end-element { fill : #FFCCFF; }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
        <!-- <script src="../release/flowchart.min.js"></script> -->
        <script>

            window.onload = function () {
                var btn = document.getElementById("run"),
                    cd = document.getElementById("code"),
                    chart;
					
                (btn.onclick = function () {
                    var code = cd.value;

                    if (chart) {
                      chart.clean();
                    }

                    chart = flowchart.parse(code);
                    chart.drawSVG('canvas', {
                      'x': 0,
                      'y': 0,
                      'line-width': 3,
                      //'maxWidth': 15,//ensures the flowcharts fits within a certain width
                      'line-length': 50,
                      'text-margin': 10,
                      'font-size': 14,
                      'font': 'normal',
                      'font-family': 'Helvetica',
                      'font-weight': 'normal',
                      'font-color': 'black',
                      'line-color': 'black',
                      'element-color': 'black',
                      'fill': 'white',
                      'yes-text': 'yes',
                      'no-text': 'no',
                      'arrow-end': 'block',
                      'scale': 1,
                      'symbols': {
                        'start': {
						  'font-size': 14,
                          'font-color': 'yellow',
                          'element-color': 'blue',
                          'fill': 'green',
						  'class': 'start-element'
                        },
                        'inputoutput': {
                          'font-color': 'black',
                          'element-color': 'black',
                          'fill': 'bisque'
                        },
                        'operation': {
                          'font-color': 'black',
                          'element-color': 'black',
                          'fill': 'linen'
                        },
                        'subroutine': {
                          'font-color': 'black',
                          'element-color': 'blue',
                          'fill': 'lightgreen'
                        },
                        'condition': {
                          'font-color': 'red',
						  'element-color': 'black',
                          'fill': 'yellow'
                        },
                        'end':{
						  'font-size': 20,
                          'class': 'end-element'
                        }
                      },
                      'flowstate' : {
                        //'past' : { 'fill' : '#CCCCCC', 'font-size' : 12},
                        //'current' : {'fill' : 'yellow', 'font-color' : 'red', 'font-weight' : 'bold'},
                        //'future' : { 'fill' : '#FFFF99'},
                        'request' : { 'fill' : 'blue'},
                        'invalid': {'fill' : '#444444'},
                        'approved' : { 'fill' : '#58C4A3', 'font-size' : 12, 'yes-text' : 'APPROVED', 'no-text' : 'n/a' },
                        'rejected' : { 'fill' : '#C45879', 'font-size' : 12, 'yes-text' : 'n/a', 'no-text' : 'REJECTED' }
                      }
                    });
					//create base64 encoding of SVG to generate download link for title(without html or htm).SVG
					var currentCanvasDIV = document.getElementById('canvas')
					var currentDrawSVG = currentCanvasDIV.innerHTML.replaceAll('ë','e');

					const OUTsvgBASE64 = btoa(currentDrawSVG)
					doctitle = document.title.replace('.html','');
					doctitle = doctitle.replace('.htm','');


					var currentCanvasDIV = document.getElementById('canvas')
					var currentDrawSVG = currentCanvasDIV.innerHTML.replaceAll('ë','e');
					svgSource = currentDrawSVG
					svgXML = currentDrawSVG;
					// Use SVG Height and Width from the SVG XML to set canvas size
					svgXMLsubstringHeight = svgXML.substring(svgXML.indexOf('height='), svgXML.indexOf('version='));
					svgXMLsubstringWidth = svgXML.substring(svgXML.indexOf('width='), svgXML.indexOf('xmlns='));
					HeightValue = svgXMLsubstringHeight.substring(svgXMLsubstringHeight.indexOf('"')+1,svgXMLsubstringHeight.lastIndexOf('"'));
					WidthValue = svgXMLsubstringWidth.substring(svgXMLsubstringWidth.indexOf('"')+1,svgXMLsubstringWidth.lastIndexOf('"'));
					HeightValueInt = Math.round(HeightValue)
					WidthValueInt = Math.round(WidthValue)
					// setup input for base64SvgToBase64Png
					let svgSrc = "data:image/svg+xml;base64,"+OUTsvgBASE64;
					var pngBase
					imageUtil.base64SvgToBase64Png(svgSrc, WidthValueInt, HeightValueInt).then(pngSrc => {
					pngBase = pngSrc
					// output download link for base64 PNG converted on download from base64
					var pngOutHtml = `<a href="${pngBase}" download="${doctitle}.png">PNG - Click here to download current rendered flowchart as ${doctitle}.png</a>`
					document.getElementById("pngbase64").innerHTML=pngOutHtml;
					});	
					// output download link for base64 SVG converted on download from base64
					var svgOutHtml = `<a href="data:image/svg+xml;base64,${OUTsvgBASE64}" download=${doctitle}.svg>SVG - Click here to download current rendered flowchart as ${doctitle}.svg</a> `
						document.getElementById("svgbase64").innerHTML=svgOutHtml;
					})();

							};
				 

// derived from https://stackoverflow.com/a/64800570
// we need to use web browser canvas to generate a image. In this case png
let imageUtil = {};
/**
 * converts a base64 encoded data url SVG image to a PNG image
 * @param originalBase64 data url of svg image
 * @param width target width in pixel of PNG image
 * @param secondTry used internally to prevent endless recursion
 * @return {Promise<unknown>} resolves to png data url of the image
 */
imageUtil.base64SvgToBase64Png = function (originalBase64, width, height, secondTry) {
    return new Promise(resolve => {
		let img = document.createElement('img');
        img.onload = function () {
            if (!secondTry && (img.naturalWidth === 0 || img.naturalHeight === 0)) {
                let svgDoc = base64ToSvgDocument(originalBase64);
                let fixedDoc = fixSvgDocumentFF(svgDoc);
                return imageUtil.base64SvgToBase64Png(svgDocumentToBase64(fixedDoc), width, height, true).then(result => {
                    resolve(result);
                });
            }
            //document.body.appendChild(img);
            let canvas2 = document.createElement("canvas");
            //document.body.removeChild(img);
            canvas2.width = width;
            canvas2.height = height;
            let ctx = canvas2.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas2.width, canvas2.height);
            try {
                let data = canvas2.toDataURL('image/png');
                resolve(data);
            } catch (e) {
                resolve(null);
            }
        };
        img.src = originalBase64;
    });
}

//needed because Firefox doesn't correctly handle SVG with size = 0, see https://bugzilla.mozilla.org/show_bug.cgi?id=700533
function fixSvgDocumentFF(svgDocument) {
    try {
        let widthInt = parseInt(svgDocument.documentElement.width.baseVal.value) || 500;
        let heightInt = parseInt(svgDocument.documentElement.height.baseVal.value) || 500;
        svgDocument.documentElement.width.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX, widthInt);
        svgDocument.documentElement.height.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX, heightInt);
        return svgDocument;
    } catch (e) {
        return svgDocument;
    }
}

function svgDocumentToBase64(svgDocument) {
    try {
        let base64EncodedSVG = btoa(new XMLSerializer().serializeToString(svgDocument));
        return 'data:image/svg+xml;base64,' + base64EncodedSVG;
    } catch (e) {
        return null;
    }
}

function base64ToSvgDocument(base64) {
    let svg = atob(base64.substring(base64.indexOf('base64,') + 7));
    svg = svg.substring(svg.indexOf('<svg'));
    let parser = new DOMParser();
    return parser.parseFromString(svg, "image/svg+xml");
} 
        </script>

		<script>
			function HelpText() {
			  var x = document.getElementById("HelpTextBlock");
			  if (x.style.display === "none") {
				x.style.display = "block";
			  } else {
				x.style.display = "none";
			  }
			}
		</script>
    </head>
    <body>
        <div><textarea id="code" style="width: 100%;" rows="11">op2=>operation: from inputs import get_gamepad, UnpluggedError
op4=>operation: '\nThe gamepad module provides an abstraction of gamepad control via class `Gamepad`. Class `Inputs` acts as an enumeration of possible inputs, giving them more readable names.\n'
op6=>operation: class Inputs():
    '\n    Assigns more human-readable names to inputs.\n    '
    SYN_REPORT = 0
    A = 1
    B = 2
    X = 3
    Y = 4
    R_BUMPER = 5
    L_BUMPER = 6
    START = 7
    SELECT = 8
    R_THUMB = 9
    L_THUMB = 10
    HOME = 11
    RY = 12
    RX = 13
    LY = 14
    LX = 15
    R_TRIGGER = 16
    L_TRIGGER = 17
    D_PAD_Y = 18
    D_PAD_X = 19
op8=>operation: PRESSED = 1
op10=>operation: RELEASED = 0
op12=>operation: LEFT = (- 1)
op14=>operation: UP = (- 1)
op16=>operation: DOWN = 1
op18=>operation: RIGHT = 1
op20=>operation: _KEYMAP = {'BTN_SOUTH': Inputs.A, 'BTN_EAST': Inputs.B, 'SYN_REPORT': Inputs.SYN_REPORT, 'BTN_NORTH': Inputs.X, 'BTN_WEST': Inputs.Y, 'BTN_START': Inputs.START, 'BTN_SELECT': Inputs.SELECT, 'BTN_THUMBR': Inputs.R_THUMB, 'BTN_THUMBL': Inputs.L_THUMB, 'BTN_MODE': Inputs.HOME, 'BTN_TR': Inputs.R_BUMPER, 'BTN_TL': Inputs.L_BUMPER, 'ABS_RZ': Inputs.R_TRIGGER, 'ABS_Z': Inputs.L_TRIGGER, 'ABS_RX': Inputs.RX, 'ABS_RY': Inputs.RY, 'ABS_Y': Inputs.LY, 'ABS_X': Inputs.LX, 'ABS_HAT0Y': Inputs.D_PAD_Y, 'ABS_HAT0X': Inputs.D_PAD_X}
op22=>operation: class Gamepad():
    '\n    Gamepad abstractions.\n    '

    def __init__(self):
        '\n        Initializes gamepad.\n        '
        self.input = None

    def update_input(self):
        '\n        Update input requests the last input given to the gamepad. This function must be called prior (in the same loop) to calling any of methods which check the value of certain inputs.\n        '
        events = get_gamepad()
        for event in events:
            self.input = (_KEYMAP[event.code], event.state)
            return self.input

    def was_pressed(self, button: int) -> bool:
        '\n        Returns true if the button corresponding to parameter `button` was pressed, otherwise returns false.\n        '
        if (button not in range(1, 12)):
            raise Exception('Invalid button! See gamepad.Gamepad!')
        elif (self.input is not None):
            return ((self.input[0] == button) and (self.input[1] == PRESSED))

    def get_stick_value(self, stick_axis: int) -> int:
        '\n        Returns the value of the specified stick axis.\n        '
        if (stick_axis not in range(12, 16)):
            raise Exception('Invalid stick input! See gamepad.Gamepad!')
        elif (self.input is not None):
            if (self.input[0] == stick_axis):
                return self.input[1]

    def get_trigger_value(self) -> int:
        "\n        Returns the current value of either stick. Left stick's values range from [-255, 0], right stick's values range from [0, 255].\n        "
        if (self.input is not None):
            if (self.input[0] == Inputs.R_TRIGGER):
                return self.input[1]
            elif (self.input[0] == Inputs.L_TRIGGER):
                return (- self.input[1])
cond25=>condition: if (__name__ == '__main__')
cond30=>condition: while True
op50=>operation: events = get_gamepad()
cond53=>operation: print(event.ev_type, event.code, event.state) while  event in events

op2->op4
op4->op6
op6->op8
op8->op10
op10->op12
op12->op14
op14->op16
op16->op18
op18->op20
op20->op22
op22->cond25
cond25(yes)->cond30
cond30(yes)->op50
op50->cond53
cond53->cond30
</textarea></div>
        <div><button id="run" type="button">Run</button> <button onclick="HelpText()">Format Help</button></div>
		<div id="HelpTextBlock" style="display:none"><br/>Conditions can also be redirected like cond(yes, bottom) or cond(yes, right)
... and the other symbols too... like sub1(right)<br/>
You can also tweak the <b>diagram.drawSVG('diagram', {});</b> script in this file for more changes<br/>
This is based on <a href="https://github.com/adrai/flowchart.js">flowchart.js on github</a> and <a href="http://flowchart.js.org">http://flowchart.js.org</a> more documentation can be found over there.
</div><br/><div id="svgbase64"></div>
		<div id="pngbase64"></div>

        <div id="canvas"></div>
    </body>
</html>