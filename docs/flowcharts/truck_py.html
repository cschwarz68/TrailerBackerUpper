<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>truck_py.html</title>
        <style type="text/css">
          .end-element { fill : #FFCCFF; }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.17.1/flowchart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
        <!-- <script src="../release/flowchart.min.js"></script> -->
        <script>

            window.onload = function () {
                var btn = document.getElementById("run"),
                    cd = document.getElementById("code"),
                    chart;
					
                (btn.onclick = function () {
                    var code = cd.value;

                    if (chart) {
                      chart.clean();
                    }

                    chart = flowchart.parse(code);
                    chart.drawSVG('canvas', {
                      'x': 0,
                      'y': 0,
                      'line-width': 3,
                      //'maxWidth': 15,//ensures the flowcharts fits within a certain width
                      'line-length': 50,
                      'text-margin': 10,
                      'font-size': 14,
                      'font': 'normal',
                      'font-family': 'Helvetica',
                      'font-weight': 'normal',
                      'font-color': 'black',
                      'line-color': 'black',
                      'element-color': 'black',
                      'fill': 'white',
                      'yes-text': 'yes',
                      'no-text': 'no',
                      'arrow-end': 'block',
                      'scale': 1,
                      'symbols': {
                        'start': {
						  'font-size': 14,
                          'font-color': 'yellow',
                          'element-color': 'blue',
                          'fill': 'green',
						  'class': 'start-element'
                        },
                        'inputoutput': {
                          'font-color': 'black',
                          'element-color': 'black',
                          'fill': 'bisque'
                        },
                        'operation': {
                          'font-color': 'black',
                          'element-color': 'black',
                          'fill': 'linen'
                        },
                        'subroutine': {
                          'font-color': 'black',
                          'element-color': 'blue',
                          'fill': 'lightgreen'
                        },
                        'condition': {
                          'font-color': 'red',
						  'element-color': 'black',
                          'fill': 'yellow'
                        },
                        'end':{
						  'font-size': 20,
                          'class': 'end-element'
                        }
                      },
                      'flowstate' : {
                        //'past' : { 'fill' : '#CCCCCC', 'font-size' : 12},
                        //'current' : {'fill' : 'yellow', 'font-color' : 'red', 'font-weight' : 'bold'},
                        //'future' : { 'fill' : '#FFFF99'},
                        'request' : { 'fill' : 'blue'},
                        'invalid': {'fill' : '#444444'},
                        'approved' : { 'fill' : '#58C4A3', 'font-size' : 12, 'yes-text' : 'APPROVED', 'no-text' : 'n/a' },
                        'rejected' : { 'fill' : '#C45879', 'font-size' : 12, 'yes-text' : 'n/a', 'no-text' : 'REJECTED' }
                      }
                    });
					//create base64 encoding of SVG to generate download link for title(without html or htm).SVG
					var currentCanvasDIV = document.getElementById('canvas')
					var currentDrawSVG = currentCanvasDIV.innerHTML.replaceAll('ë','e');

					const OUTsvgBASE64 = btoa(currentDrawSVG)
					doctitle = document.title.replace('.html','');
					doctitle = doctitle.replace('.htm','');


					var currentCanvasDIV = document.getElementById('canvas')
					var currentDrawSVG = currentCanvasDIV.innerHTML.replaceAll('ë','e');
					svgSource = currentDrawSVG
					svgXML = currentDrawSVG;
					// Use SVG Height and Width from the SVG XML to set canvas size
					svgXMLsubstringHeight = svgXML.substring(svgXML.indexOf('height='), svgXML.indexOf('version='));
					svgXMLsubstringWidth = svgXML.substring(svgXML.indexOf('width='), svgXML.indexOf('xmlns='));
					HeightValue = svgXMLsubstringHeight.substring(svgXMLsubstringHeight.indexOf('"')+1,svgXMLsubstringHeight.lastIndexOf('"'));
					WidthValue = svgXMLsubstringWidth.substring(svgXMLsubstringWidth.indexOf('"')+1,svgXMLsubstringWidth.lastIndexOf('"'));
					HeightValueInt = Math.round(HeightValue)
					WidthValueInt = Math.round(WidthValue)
					// setup input for base64SvgToBase64Png
					let svgSrc = "data:image/svg+xml;base64,"+OUTsvgBASE64;
					var pngBase
					imageUtil.base64SvgToBase64Png(svgSrc, WidthValueInt, HeightValueInt).then(pngSrc => {
					pngBase = pngSrc
					// output download link for base64 PNG converted on download from base64
					var pngOutHtml = `<a href="${pngBase}" download="${doctitle}.png">PNG - Click here to download current rendered flowchart as ${doctitle}.png</a>`
					document.getElementById("pngbase64").innerHTML=pngOutHtml;
					});	
					// output download link for base64 SVG converted on download from base64
					var svgOutHtml = `<a href="data:image/svg+xml;base64,${OUTsvgBASE64}" download=${doctitle}.svg>SVG - Click here to download current rendered flowchart as ${doctitle}.svg</a> `
						document.getElementById("svgbase64").innerHTML=svgOutHtml;
					})();

							};
				 

// derived from https://stackoverflow.com/a/64800570
// we need to use web browser canvas to generate a image. In this case png
let imageUtil = {};
/**
 * converts a base64 encoded data url SVG image to a PNG image
 * @param originalBase64 data url of svg image
 * @param width target width in pixel of PNG image
 * @param secondTry used internally to prevent endless recursion
 * @return {Promise<unknown>} resolves to png data url of the image
 */
imageUtil.base64SvgToBase64Png = function (originalBase64, width, height, secondTry) {
    return new Promise(resolve => {
		let img = document.createElement('img');
        img.onload = function () {
            if (!secondTry && (img.naturalWidth === 0 || img.naturalHeight === 0)) {
                let svgDoc = base64ToSvgDocument(originalBase64);
                let fixedDoc = fixSvgDocumentFF(svgDoc);
                return imageUtil.base64SvgToBase64Png(svgDocumentToBase64(fixedDoc), width, height, true).then(result => {
                    resolve(result);
                });
            }
            //document.body.appendChild(img);
            let canvas2 = document.createElement("canvas");
            //document.body.removeChild(img);
            canvas2.width = width;
            canvas2.height = height;
            let ctx = canvas2.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas2.width, canvas2.height);
            try {
                let data = canvas2.toDataURL('image/png');
                resolve(data);
            } catch (e) {
                resolve(null);
            }
        };
        img.src = originalBase64;
    });
}

//needed because Firefox doesn't correctly handle SVG with size = 0, see https://bugzilla.mozilla.org/show_bug.cgi?id=700533
function fixSvgDocumentFF(svgDocument) {
    try {
        let widthInt = parseInt(svgDocument.documentElement.width.baseVal.value) || 500;
        let heightInt = parseInt(svgDocument.documentElement.height.baseVal.value) || 500;
        svgDocument.documentElement.width.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX, widthInt);
        svgDocument.documentElement.height.baseVal.newValueSpecifiedUnits(SVGLength.SVG_LENGTHTYPE_PX, heightInt);
        return svgDocument;
    } catch (e) {
        return svgDocument;
    }
}

function svgDocumentToBase64(svgDocument) {
    try {
        let base64EncodedSVG = btoa(new XMLSerializer().serializeToString(svgDocument));
        return 'data:image/svg+xml;base64,' + base64EncodedSVG;
    } catch (e) {
        return null;
    }
}

function base64ToSvgDocument(base64) {
    let svg = atob(base64.substring(base64.indexOf('base64,') + 7));
    svg = svg.substring(svg.indexOf('<svg'));
    let parser = new DOMParser();
    return parser.parseFromString(svg, "image/svg+xml");
} 
        </script>

		<script>
			function HelpText() {
			  var x = document.getElementById("HelpTextBlock");
			  if (x.style.display === "none") {
				x.style.display = "block";
			  } else {
				x.style.display = "none";
			  }
			}
		</script>
    </head>
    <body>
        <div><textarea id="code" style="width: 100%;" rows="11">op2=>operation: '\nThis module functions as an abstraction for the Truck via. the singleton class Truck. It provides control over drive and steering rack motors, \nas well as some autonomous driving functionality.\n'
op4=>operation: from constants import DriveParams, GPIO
op6=>operation: from gpio import DCMotor, Servo, cleanup
op8=>operation: class Truck():
    _self = None
    '\n    The car class controls driving and steering of the car. Should only instantiate once.\n    '

    def __new__(cls):
        if (cls._self is None):
            cls._self = super().__new__(cls)
        return cls._self

    def __init__(self):
        '\n        Create instance of car with initial steering angle at center position. Instantiates steering motor and drive motor at appropriate pins. Uses BCM pin numbering system.\n        '
        self.current_steering_angle = 0
        self.current_drive_power = 0
        self.steer_motor: Servo = Servo(GPIO.SERVO_MOTOR_PIN)
        self.drive_motor: DCMotor = DCMotor(GPIO.DRIVE_MOTOR_POWER_PIN, GPIO.DRIVE_MOTOR_FORWARD_PIN, GPIO.DRIVE_MOTOR_REVERSE_PIN)
        self.jackknifed = False

    def gamepad_drive(self, trigger_val: int):
        '\n        Input to this function must range from [-255, 255] where -255 is full reverse, 0 is stop, and 255 is full forward.\n        Note that src.gamepad.get_trigger_values() maps [-255, 0] to left trigger, and [0,255] to right trigger\n        '
        self.set_drive_power((trigger_val / 255))

    def set_drive_power(self, power: float):
        '\n        Sets the drive power of the motor. Input should range from [-1, 1] where -1 is full reverse, 0 is stop, and 1 is full forward.\n        '
        duty_cycle: int = int(abs((power * 100)))
        if (power < 0):
            self.drive_motor.reverse()
        elif (power > 0):
            self.drive_motor.forward()
        else:
            self.drive_motor.stop_rotation()
        self.current_drive_power = power
        self.drive_motor.set_power(duty_cycle)

    def gamepad_steer(self, stick_val: float):
        '\n        Input to this function must range from [-32768, 32767] where -32768 corresponds to full left, 0 to center, and 32767 to full right.\n        This is the range of values provided by gamepad analog stick input.\n        '
        JOYSTICK_MAX = 32767.0
        STEERING_RACK_MAX = 21
        ANGLE_NORMALIZATION_CONSTANT = (JOYSTICK_MAX / STEERING_RACK_MAX)
        angle = (stick_val / ANGLE_NORMALIZATION_CONSTANT)
        self.set_steering_angle(angle)

    def set_steering_angle(self, angle: float):
        '\n        Inputs must range from [-21, 21]. Bad inputs will be clamped.\n        '
        (LEFT_STEERING_RATIO, RIGHT_STEERING_RATIO) = ((21 / 60), (31 / 60))
        if (angle > 22):
            angle = 21
        elif (angle < (- 22)):
            angle = (- 21)
        self.current_steering_angle = angle
        angle = ((angle / LEFT_STEERING_RATIO) if (angle < 0) else (angle / RIGHT_STEERING_RATIO))
        self.steer_motor.set_angle((angle + DriveParams.STEERING_RACK_CENTER))

    def stabilize_steering_angle(self, new_angle, num_of_lane_lines, max_angle_deviation_two_lines=40, max_angle_deviation_one_line=40):
        '\n        Prevents some extreme input from resulting in an extreme steering reaction.\n        Clamps steering angle based on previous steering angle.\n        '
        if (num_of_lane_lines == 2):
            max_angle_deviation = max_angle_deviation_two_lines
        else:
            max_angle_deviation = max_angle_deviation_one_line
        angle_deviation = (new_angle - self.current_steering_angle)
        if (abs(angle_deviation) > max_angle_deviation):
            stabilized_steering_angle = int((self.current_steering_angle + ((max_angle_deviation * angle_deviation) / abs(angle_deviation))))
        else:
            stabilized_steering_angle = new_angle
        self.current_steering_angle = stabilized_steering_angle
        return stabilized_steering_angle

    def stop(self):
        '\n        Stop steering and drive motors.\n        '
        self.set_steering_angle(0)
        self.current_steering_angle = 0
        self.steer_motor.stop()
        self.drive_motor.stop()

    def cleanup(self):
        cleanup()
cond11=>condition: if (__name__ == '__main__')
op15=>operation: from gamepad import Gamepad, Inputs
op17=>operation: g = Gamepad()
op19=>operation: car = Truck()
cond22=>condition: while True
sub64=>subroutine: g.update_input()
cond67=>condition: if g.was_pressed(Inputs.R_BUMPER)
sub71=>subroutine: car.set_steering_angle((car.current_steering_angle + 1))
sub73=>subroutine: print('angle:', car.current_steering_angle)
cond78=>condition: if g.was_pressed(Inputs.L_BUMPER)
sub82=>subroutine: car.set_steering_angle((car.current_steering_angle - 1))
sub84=>subroutine: print(car.current_steering_angle)
cond89=>operation: break if  g.was_pressed(Inputs.B)

op2->op4
op4->op6
op6->op8
op8->cond11
cond11(yes)->op15
op15->op17
op17->op19
op19->cond22
cond22(yes)->sub64
sub64->cond67
cond67(yes)->sub71
sub71->sub73
sub73->cond22
cond67(no)->cond78
cond78(yes)->sub82
sub82->sub84
sub84->cond22
cond78(no)->cond89
cond89->cond22
</textarea></div>
        <div><button id="run" type="button">Run</button> <button onclick="HelpText()">Format Help</button></div>
		<div id="HelpTextBlock" style="display:none"><br/>Conditions can also be redirected like cond(yes, bottom) or cond(yes, right)
... and the other symbols too... like sub1(right)<br/>
You can also tweak the <b>diagram.drawSVG('diagram', {});</b> script in this file for more changes<br/>
This is based on <a href="https://github.com/adrai/flowchart.js">flowchart.js on github</a> and <a href="http://flowchart.js.org">http://flowchart.js.org</a> more documentation can be found over there.
</div><br/><div id="svgbase64"></div>
		<div id="pngbase64"></div>

        <div id="canvas"></div>
    </body>
</html>